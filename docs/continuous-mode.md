# 连续模式「一键到底」架构蓝图

## 1. 愿景与验收
- **目标**：用户提供一次性初始上下文后，Codex 自动规划、执行并收敛到可交付成果，过程中只在必要断点请求确认。
- **成功标准**：
  - CLI/TUI 中的 `--continuous` 启动流程可自动生成计划、按步骤执行并输出终局报告。
  - 支持暂停/恢复、断点确认以及失败后的安全退出。
  - 所有动作、状态和产物可追溯（日志 + 状态快照）。

## 2. 用户旅程
1. `codex --continuous` 或 `codex resume --continuous` 启动，进入连续模式预览屏。
2. 预览界面展示：初始提示、自动提炼的需求摘要、计划预览、执行护栏（步数、超时、断点策略）。
3. 用户确认后进入自动循环；TUI 顶部显示当前任务、进度条和最近命令。
4. 遇到断点、错误或防护触发时暂停，用户可选择继续、编辑计划或终止。
5. 完成后输出终局报告并写入日志，可再次用 `codex resume <id>` 继续后续任务。

## 3. 核心组件
- **Planner**：
  - 输入用户需求，输出结构化 `PlanItem` 列表（task_id、描述、依赖、断点标记、风险等级）。
  - 支持增量 replanning：执行失败或需求变化时更新原有任务图。
- **Task State Machine**：
  - 状态：`pending → ready → active → done/failed`，`blocked` 用于等待依赖或人工确认。
  - 所有转移写入事件流（用于回放和调试）。
- **Continuous Runner**：
  - 无限循环：选取 `ready` 任务 → 准备上下文 → 调用执行器（shell/git/tool/plan update） → 更新状态。
  - 执行后根据结果决定是否触发 replanning 或 fallback。
- **Guard Rails**：
  - 监控失败次数、连续无效迭代、长时间执行无输出、磁盘/仓库外部变更。
  - 合规场景（危险命令、长跑测试）强制二次确认。
  - 当检测到同一命令多次执行却没有任何输出或代码变更时，自动判定为“卡住”并暂停，提示人工处理。
  - 命令失败会记录重试次数，超过阈值后自动暂停并提示最大失败次数，避免无休止的错误循环。
- **Persistence Layer**：
  - `.codex/state/continuous/<session>.json` 保存计划、任务状态、runner 游标、配置、最近输出摘要。
  - 自动滚动历史快照，并提供 `codex resume` 恢复入口。
- **Logging**：
  - 终端里显示步骤摘要、命令结果、审批状态。
  - 文件中记录完整事件（JSONL）+ 终局报告。

## 4. 执行流程
1. **初始化**：加载配置 → Canonicalize CWD → 生成或恢复计划 → 计算默认护栏。
2. **选择任务**：`ready_queue` 依优先级（依赖深度/风险）排序；支持并发时考虑资源约束。
3. **执行**：
   - 构建提示（历史上下文 + 任务描述 + 约束）。
   - 使用统一执行器触发工具调用（shell/git/file search/plan update/...）。
   - 收集命令输出和 diff，写入历史。
4. **收敛检查**：判断任务是否完成（计划更新、diff 达到预期、测试通过）；失败则记录并选择处理策略。
5. **防护触发**：出现异常时切换到 `blocked` 并展示原因，用户确认后继续或回退。
6. **终局**：所有 `pending` 任务完成或用户强制结束 → 生成终局报告（完成度、命令、测试、待办）。

## 5. 断点与审批
- Plan 中的 `breakpoint=true` 任务执行前暂停，展示任务摘要和预估影响。
- 支持策略：自动确认、默认确认、全部要求确认。
- 升级路径：当检测到潜在危险操作（`rm -rf`, mass rename 等）时即使无断点也触发确认。

## 6. 防护策略
- **失败重试**：同一任务默认重试 2 次，可配置退避；超过阈值则暂停。
- **无效迭代**：连续 N 次 diff 为零或测试未执行 → 标记为 `stalled`，提示用户提供更多信息。
- **时间和步数上限**：`--max-steps`、执行总时长、空闲时间；超出后暂停。
- **外部改动检测**：执行前后跑 `git status --short`，出现非 Codex 产生的改动时暂停。
- **资源监控（未来）**：CPU/内存异常、长时间运行命令警告。

## 7. 状态持久化 & 恢复
- 会话目录结构：
  ```
  .codex/state/continuous/<session>/
    plan.json          # 最新任务图
    tasks.json         # 状态机快照
    runner.json        # 当前游标、计数器
    events.jsonl       # 历史事件
    summary.md         # 上次报告
  ```
- `codex resume --continuous`：
  - 读取快照 → 校验环境（Git 状态、依赖） → 恢复 Runner → 继续执行。
  - 若快照过期（文件差异、依赖失效），先触发 replanning。

## 8. CLI/TUI 集成
- CLI：`--continuous`、`--max-steps`、`--confirm-on-breakpoint`、`--resume-last`。
- TUI：
  - 预览界面让用户编辑提示和护栏，展示计划摘要。
  - 主界面新增「连续模式」面板：任务列表、状态、命令输出、断点提示。
  - 支持快捷键：`c` 继续、`p` 暂停、`r` 重试、`b` 跳过、`h` 帮助。

## 9. 配置与默认值
- `config.toml` 新增 `[continuous]`：
  - `default_max_steps`、`default_confirm_on_breakpoint`、`stop_conditions`。
  - `log_dir`、`snapshot_retention`、`auto_resume`。
- 优先级：CLI > 环境变量 > 配置文件。
- 默认行为：步数 20、断点确认开启、失败重试 2 次、最大连续空操作 3 次。

## 10. 质量保障
- **单元测试**：状态机、计划解析、停止条件、持久化读写。
- **集成测试**：
  - 模拟连续会话：正常路径、断点路径、失败重试、外部改动。
  - Snapshot 测试验证 TUI 渲染。
  - CLI smoke tests 覆盖 resume 和参数组合。
- **手动 QA 清单**：
  - 快速任务完成。
  - 带断点的暂停/继续。
  - 失败后恢复。
  - 外部改动检测。
  - 恢复后继续执行。

## 11. 迭代路线
1. **MVP**：单线程 Runner + 状态机 + 持久化 + 断点确认。
2. **增强**：增量 replanning、并发任务、动态护栏调整。
3. **观察指标**：平均完成时间、自动暂停次数、人工干预次数、失败率。
4. **GA 判断**：稳定性达标 + 关键指标达到预期 → 默认开启连续模式，保留退回开关。
